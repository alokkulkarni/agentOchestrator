version: '3.8'

services:
  # ==========================================
  # Model Gateway Service
  # ==========================================
  model-gateway:
    build:
      context: .
      dockerfile: model_gateway/Dockerfile
    container_name: model-gateway
    env_file:
      - .env  # Load environment variables from .env file
    ports:
      - "8585:8585"   # API and metrics endpoint (/metrics)
    environment:
      # Server settings
      - GATEWAY_HOST=${GATEWAY_HOST:-0.0.0.0}
      - GATEWAY_PORT=${GATEWAY_PORT:-8585}
      - GATEWAY_RELOAD=${GATEWAY_RELOAD:-false}
      - GATEWAY_LOG_LEVEL=${GATEWAY_LOG_LEVEL:-INFO}
      - GATEWAY_LOG_REQUESTS=${GATEWAY_LOG_REQUESTS:-true}

      # Authentication
      - GATEWAY_REQUIRE_AUTH=${GATEWAY_REQUIRE_AUTH:-false}
      - GATEWAY_API_KEY=${GATEWAY_API_KEY}

      # Provider credentials (using shared ANTHROPIC_API_KEY)
      - GATEWAY_ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GATEWAY_AWS_REGION=${AWS_REGION:-us-east-1}
      - GATEWAY_AWS_PROFILE=${AWS_PROFILE}

      # AWS credentials (if not using IAM role)
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN}

      # Observability - Distributed Tracing (OpenTelemetry)
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT:-http://jaeger:4317}
      - OTEL_CONSOLE=${OTEL_CONSOLE:-false}

    volumes:
      # Mount config (read-only)
      - ./model_gateway/config:/app/model_gateway/config:ro
      # Mount logs (read-write)
      - gateway-logs:/app/model_gateway/logs

    networks:
      - agent-network

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8585/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    logging:
      driver: ${LOG_DRIVER:-json-file}
      options:
        max-size: ${LOG_MAX_SIZE:-10m}
        max-file: ${LOG_MAX_FILE:-3}

  # ==========================================
  # Agent Orchestrator API Service
  # ==========================================
  orchestrator-api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: orchestrator-api
    env_file:
      - .env  # Load environment variables from .env file
    ports:
      - "8001:8001"   # API server
      - "9090:9090"   # Prometheus metrics endpoint
    environment:
      # API Server Configuration
      - ORCHESTRATOR_API_HOST=0.0.0.0
      - ORCHESTRATOR_API_PORT=8001
      - ORCHESTRATOR_API_RELOAD=false
      - ORCHESTRATOR_API_LOG_LEVEL=info

      # Authentication (optional)
      - ORCHESTRATOR_REQUIRE_AUTH=${ORCHESTRATOR_REQUIRE_AUTH:-false}
      - ORCHESTRATOR_API_KEY=${ORCHESTRATOR_API_KEY}

      # Anthropic API key (for direct provider)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}

      # Tavily API key (for web search)
      - TAVILY_API_KEY=${TAVILY_API_KEY}

      # Gateway URL (internal Docker network)
      - GATEWAY_URL=http://model-gateway:8585

      # Observability - Distributed Tracing (OpenTelemetry)
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT:-http://jaeger:4317}

      # Configuration
      - ORCHESTRATOR_CONFIG=/app/config/orchestrator.yaml

    volumes:
      # Mount config (read-only)
      - ./config:/app/config:ro
      # Mount logs (read-write)
      - orchestrator-logs:/app/logs

    networks:
      - agent-network

    depends_on:
      model-gateway:
        condition: service_healthy

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    logging:
      driver: ${LOG_DRIVER:-json-file}
      options:
        max-size: ${LOG_MAX_SIZE:-10m}
        max-file: ${LOG_MAX_FILE:-3}

  # ==========================================
  # Agent Orchestrator CLI (for testing)
  # ==========================================
  orchestrator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: orchestrator-cli
    environment:
      # Anthropic API key (for direct provider)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}

      # Tavily API key (for web search)
      - TAVILY_API_KEY=${TAVILY_API_KEY}

      # Gateway URL (internal Docker network)
      - GATEWAY_URL=http://model-gateway:8585

      # Observability - Distributed Tracing (OpenTelemetry)
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT:-http://jaeger:4317}

    volumes:
      # Mount config (read-only)
      - ./config:/app/config:ro
      # Mount examples (read-only)
      - ./examples:/app/examples:ro
      # Mount agent_orchestrator package
      - ./agent_orchestrator:/app/agent_orchestrator:ro

    networks:
      - agent-network

    depends_on:
      model-gateway:
        condition: service_healthy

    restart: unless-stopped

    profiles:
      - cli  # Only start with: docker-compose --profile cli up

    logging:
      driver: ${LOG_DRIVER:-json-file}
      options:
        max-size: ${LOG_MAX_SIZE:-10m}
        max-file: ${LOG_MAX_FILE:-3}

  # ==========================================
  # Interactive Test Service
  # ==========================================
  interactive-test:
    build:
      context: .
      dockerfile: Dockerfile.interactive
    container_name: interactive-test
    stdin_open: true
    tty: true
    environment:
      # Anthropic API key
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}

      # Tavily API key
      - TAVILY_API_KEY=${TAVILY_API_KEY}

      # Gateway URL (internal Docker network)
      - GATEWAY_URL=http://model-gateway:8585

    volumes:
      # Mount config (read-only)
      - ./config:/app/config:ro
      # Mount examples (read-only)
      - ./examples:/app/examples:ro
      # Mount agent_orchestrator package
      - ./agent_orchestrator:/app/agent_orchestrator:ro
      # Mount test script
      - ./test_orchestrator_interactive.py:/app/test_orchestrator_interactive.py:ro

    networks:
      - agent-network

    depends_on:
      model-gateway:
        condition: service_healthy
      orchestrator-api:
        condition: service_healthy

    profiles:
      - interactive

    logging:
      driver: ${LOG_DRIVER:-json-file}
      options:
        max-size: ${LOG_MAX_SIZE:-10m}
        max-file: ${LOG_MAX_FILE:-3}

  # ==========================================
  # Jaeger (Distributed Tracing)
  # ==========================================
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: jaeger
    ports:
      - "16686:16686"  # Jaeger UI
      - "4317:4317"    # OTLP gRPC receiver
      - "4318:4318"    # OTLP HTTP receiver
    environment:
      - COLLECTOR_OTLP_ENABLED=true
      - LOG_LEVEL=info
    networks:
      - agent-network
    restart: unless-stopped
    profiles:
      - monitoring  # Only start with: docker-compose --profile monitoring up

  # ==========================================
  # Prometheus (Metrics Collection)
  # ==========================================
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9091:9090"  # Prometheus UI (external:internal)
    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    networks:
      - agent-network
    depends_on:
      - model-gateway
      - orchestrator-api
    restart: unless-stopped
    profiles:
      - monitoring  # Only start with: docker-compose --profile monitoring up

# ==========================================
# Networks
# ==========================================
networks:
  agent-network:
    driver: bridge
    name: agent-orchestrator-network

# ==========================================
# Volumes
# ==========================================
volumes:
  gateway-logs:
    name: model-gateway-logs
  orchestrator-logs:
    name: orchestrator-api-logs
  prometheus-data:
    name: prometheus-metrics-data
